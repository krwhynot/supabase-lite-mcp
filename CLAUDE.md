# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a lightweight MCP (Model Context Protocol) server for Supabase that provides essential database management commands while minimizing token usage. It reduces token consumption from ~14,800 to ~3,700 tokens by exposing only 8 core database commands instead of the full 26.

## Commands

### Build and Development
```bash
# Install dependencies
npm install

# Build TypeScript to JavaScript
npm run build

# Run in development mode (uses tsx for hot reload)
npm run dev

# Run production build
npm run start

# Clean build artifacts
npm run clean

# Run automated setup
./setup.sh
```

### Environment Setup
Before running, ensure `.env` file exists with:
- `SUPABASE_URL`: Your Supabase project URL
- `SUPABASE_SERVICE_KEY`: Service role key (not anon key)
- `SUPABASE_PROJECT_REF`: Optional project reference

Copy from template: `cp .env.example .env`

## Architecture

### File Structure
- `src/index.ts`: Main server implementation with all MCP protocol handling
- `dist/`: Compiled JavaScript output (generated by build)
- `package.json`: Node project configuration (Node v22+ required)
- `tsconfig.json`: TypeScript compiler configuration
- `setup.sh`: Automated installation script
- `.env.example`: Environment variable template

### Key Components

1. **SupabaseLiteMCPServer Class**: Core server handling MCP protocol communications
   - Initializes MCP server with stdio transport
   - Manages Supabase client connection
   - Routes commands to appropriate handlers

2. **Command System**:
   - Commands defined in `ALLOWED_COMMANDS` array
   - Each command has:
     - Tool definition (name, description, input schema)
     - Handler method implementation
     - MCP protocol response formatting

3. **Available Commands** (8 total):
   - `list_tables`: List database tables in specified schemas
   - `list_extensions`: Show installed PostgreSQL extensions
   - `list_migrations`: Display migration history
   - `apply_migration`: Apply DDL changes (CREATE TABLE, etc.)
   - `execute_sql`: Run SQL queries for data operations
   - `get_logs`: Retrieve service logs from last minute
   - `get_advisors`: Get security/performance recommendations
   - `generate_typescript_types`: Create TypeScript interfaces from schema

### Technical Details

- **Protocol**: Uses MCP (Model Context Protocol) over stdio
- **Node.js**: Requires v22+ for ES module support
- **Dependencies**:
  - `@modelcontextprotocol/sdk`: MCP protocol implementation
  - `@supabase/supabase-js`: Supabase client library
  - `dotenv`: Environment variable management
- **TypeScript**: Targets ES2022, uses Node16 module resolution
- **Module System**: ES modules with .js extensions in imports

### Adding New Commands

To add a command:
1. Add to `ALLOWED_COMMANDS` array in `src/index.ts`
2. Add tool definition in `getToolDefinitions()` method
3. Add case in `executeCommand()` switch statement
4. Implement handler method with Supabase API calls

### Integration

The server integrates with Claude via `.mcp.json` configuration:
```json
{
  "mcpServers": {
    "supabase-lite": {
      "command": "node",
      "args": ["path/to/dist/index.js"],
      "env": {
        "SUPABASE_URL": "${SUPABASE_URL}",
        "SUPABASE_SERVICE_KEY": "${SUPABASE_SERVICE_KEY}"
      }
    }
  }
}
```

## Important Notes

- The service role key has full database access - handle with care
- Never commit `.env` file or expose keys in code
- The server uses stdio for communication with Claude
- All database operations go through Supabase's REST API
- Build output includes source maps for debugging